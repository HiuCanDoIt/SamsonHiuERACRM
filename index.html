<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERA CRM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #fff5f5 0%, #f5f5f5 100%); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .logo { background: #dc2626; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 20px; }
        h1 { font-size: 28px; color: #333; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-label { color: #666; font-size: 14px; }
        .stat-value { font-size: 24px; font-weight: bold; margin-top: 5px; }
        .search-bar { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #dc2626; color: white; }
        .btn-primary:hover { background: #b91c1c; }
        .btn-secondary { background: #f3f4f6; color: #333; }
        .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-header { padding: 15px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-weight: 600; }
        .list { max-height: 600px; overflow-y: auto; }
        .list-item { padding: 15px; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .list-item:hover { background: #f9fafb; }
        .list-item.active { background: #fef2f2; border-left: 4px solid #dc2626; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-top: 5px; }
        .badge-buyer { background: #dbeafe; color: #1e40af; }
        .badge-seller { background: #d1fae5; color: #065f46; }
        .badge-tenant { background: #e0e7ff; color: #5b21b6; }
        .badge-landlord { background: #fed7aa; color: #92400e; }
        .details { padding: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal.show { display: flex; align-items: start; justify-content: center; }
        .modal-content { background: white; border-radius: 8px; max-width: 800px; width: 100%; margin: 40px auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }
        .section-title { font-weight: 600; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 2px solid #e5e7eb; }
        .id-scan { background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .camera-box { background: #000; border-radius: 8px; margin: 10px 0; overflow: hidden; }
        .camera-box video { width: 100%; height: 200px; object-fit: cover; }
        textarea { resize: vertical; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ERA</div>
            <h1>Client & Lead Management</h1>
        </div>

        <div class="stats">
            <div class="stat"><div class="stat-label">Total</div><div class="stat-value" id="total">0</div></div>
            <div class="stat"><div class="stat-label">Buyers</div><div class="stat-value" style="color:#2563eb" id="buyers">0</div></div>
            <div class="stat"><div class="stat-label">Sellers</div><div class="stat-value" style="color:#16a34a" id="sellers">0</div></div>
            <div class="stat"><div class="stat-label">Tenants</div><div class="stat-value" style="color:#7c3aed" id="tenants">0</div></div>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search..." id="search">
            <button class="btn btn-primary" onclick="openAdd()">+ Add Client</button>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header" id="listTitle">Clients (0)</div>
                <div class="list" id="list"></div>
            </div>
            <div class="card">
                <div id="detail"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Client</h2>
                <button class="btn btn-secondary" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="id-scan">
                    <strong>ID Scan (Optional)</strong>
                    <p style="font-size:13px;margin:5px 0;">Scan NRIC/ID to auto-fill</p>
                    <div id="camView" style="display:none">
                        <div class="camera-box"><video id="vid" autoplay playsinline></video></div>
                        <button class="btn btn-primary" onclick="snap()" id="snapBtn">üì∑ Capture</button>
                        <button class="btn btn-secondary" onclick="stopCam()">Cancel</button>
                    </div>
                    <div id="camBtns">
                        <button class="btn btn-primary" onclick="startCam()">üì∑ Camera</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('file').click()">üì§ Upload</button>
                    </div>
                    <input type="file" id="file" accept="image/*" style="display:none" onchange="upload(event)">
                    <canvas id="can" style="display:none"></canvas>
                </div>

                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="name">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Phone *</label>
                        <input type="tel" class="form-input" id="phone" placeholder="+65">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nationality</label>
                        <input type="text" class="form-input" id="nat">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Occupation</label>
                        <input type="text" class="form-input" id="job">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Religion</label>
                        <select class="form-select" id="rel">
                            <option value="">Select</option>
                            <option>Buddhism</option>
                            <option>Christianity</option>
                            <option>Islam</option>
                            <option>Hinduism</option>
                            <option>Taoism</option>
                            <option>No Religion</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Marital Status</label>
                        <select class="form-select" id="mar">
                            <option value="">Select</option>
                            <option>Single</option>
                            <option>Married</option>
                            <option>Divorced</option>
                            <option>Widowed</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Kids</label>
                        <input type="number" class="form-input" id="kids" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="type">
                            <option value="buyer">Buyer</option>
                            <option value="seller">Seller</option>
                            <option value="tenant">Tenant</option>
                            <option value="landlord">Landlord</option>
                        </select>
                    </div>
                </div>

                <div class="section-title">Current Property</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="curType">
                            <option value="">Select</option>
                            <option>HDB 2-Room</option>
                            <option>HDB 3-Room</option>
                            <option>HDB 4-Room</option>
                            <option>HDB 5-Room</option>
                            <option>HDB Executive</option>
                            <option>Condominium</option>
                            <option>Landed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="curLoc">
                    </div>
                </div>

                <div class="section-title">Desired Property</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="desType">
                            <option value="">Select</option>
                            <option>HDB 2-Room</option>
                            <option>HDB 3-Room</option>
                            <option>HDB 4-Room</option>
                            <option>HDB 5-Room</option>
                            <option>HDB Executive</option>
                            <option>Condominium</option>
                            <option>Landed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="desLoc">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Bedrooms</label>
                        <input type="text" class="form-input" id="beds">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="text" class="form-input" id="bud">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Move Date</label>
                    <input type="date" class="form-input" id="date">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="save()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'YOUR_API_KEY_HERE';
        let clients = [];
        let sel = null;
        let editId = null;
        let stream = null;

        init();

        function init() {
            const d = localStorage.getItem('era');
            if (d) clients = JSON.parse(d);
            if (clients.length === 0) {
                clients = [{id:'s1',name:'Tan Wei Ming',phone:'+65 9123 4567',email:'wei@email.com',nat:'Singaporean',job:'Engineer',rel:'Buddhism',mar:'Married',kids:'2',type:'buyer',desType:'HDB 4-Room',desLoc:'Tampines',bud:'800000',notes:'Sample client'}];
                saveData();
            }
            render();
            document.getElementById('search').addEventListener('input', render);
        }

        function saveData() {
            localStorage.setItem('era', JSON.stringify(clients));
            render();
        }

        function render() {
            const q = document.getElementById('search').value.toLowerCase();
            const filtered = clients.filter(c => c.name.toLowerCase().includes(q) || c.phone.includes(q) || (c.email && c.email.toLowerCase().includes(q)));
            
            document.getElementById('listTitle').textContent = `Clients (${filtered.length})`;
            document.getElementById('total').textContent = clients.length;
            document.getElementById('buyers').textContent = clients.filter(c => c.type === 'buyer').length;
            document.getElementById('sellers').textContent = clients.filter(c => c.type === 'seller').length;
            document.getElementById('tenants').textContent = clients.filter(c => c.type === 'tenant').length;

            const list = document.getElementById('list');
            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:#999">No clients</div>';
                return;
            }

            list.innerHTML = filtered.map(c => `
                <div class="list-item ${sel?.id === c.id ? 'active' : ''}" onclick="select('${c.id}')">
                    <div style="font-weight:600">${c.name}</div>
                    <div style="font-size:14px;color:#666">${c.phone}</div>
                    <span class="badge badge-${c.type}">${c.type}</span>
                </div>
            `).join('');

            showDetail();
        }

        function select(id) {
            sel = clients.find(c => c.id === id);
            render();
        }

        function showDetail() {
            const el = document.getElementById('detail');
            if (!sel) {
                el.innerHTML = '<div style="padding:80px 20px;text-align:center;color:#999"><p style="font-size:18px">Select a client</p></div>';
                return;
            }

            const c = sel;
            el.innerHTML = `
                <div class="details">
                    <div style="display:flex;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
                        <div>
                            <h2 style="margin-bottom:5px">${c.name}</h2>
                            <span class="badge badge-${c.type}">${c.type}</span>
                        </div>
                        <div style="display:flex;gap:5px">
                            <button onclick="wa('${c.phone}','${c.name}')" style="background:none;border:none;font-size:24px;cursor:pointer">üí¨</button>
                            <button onclick="edit('${c.id}')" style="background:none;border:none;font-size:24px;cursor:pointer">‚úèÔ∏è</button>
                            <button onclick="del('${c.id}')" style="background:none;border:none;font-size:24px;cursor:pointer">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                        <div>
                            <h3 style="margin-bottom:10px">Contact</h3>
                            <p>üìû ${c.phone}</p>
                            ${c.email ? `<p>üìß ${c.email}</p>` : ''}
                        </div>
                        <div>
                            <h3 style="margin-bottom:10px">Personal</h3>
                            ${c.nat ? `<p>Nationality: ${c.nat}</p>` : ''}
                            ${c.job ? `<p>Job: ${c.job}</p>` : ''}
                            ${c.rel ? `<p>Religion: ${c.rel}</p>` : ''}
                            ${c.mar ? `<p>Marital: ${c.mar}</p>` : ''}
                            ${c.kids ? `<p>Kids: ${c.kids}</p>` : ''}
                        </div>
                    </div>
                    ${c.curType || c.curLoc ? `
                        <div style="margin:20px 0;padding-top:20px;border-top:1px solid #e5e7eb">
                            <h3>Current Property</h3>
                            ${c.curType ? `<p>Type: ${c.curType}</p>` : ''}
                            ${c.curLoc ? `<p>Location: ${c.curLoc}</p>` : ''}
                        </div>
                    ` : ''}
                    ${c.desType || c.desLoc ? `
                        <div style="margin:20px 0;padding-top:20px;border-top:1px solid #e5e7eb">
                            <h3>Desired Property</h3>
                            ${c.desType ? `<p>Type: ${c.desType}</p>` : ''}
                            ${c.desLoc ? `<p>Location: ${c.desLoc}</p>` : ''}
                            ${c.beds ? `<p>Bedrooms: ${c.beds}</p>` : ''}
                            ${c.bud ? `<p>Budget: $${c.bud}</p>` : ''}
                        </div>
                    ` : ''}
                    ${c.notes ? `<div style="background:#f9fafb;padding:15px;border-radius:8px;margin-top:20px"><h3 style="margin-bottom:10px">Notes</h3><p style="white-space:pre-wrap">${c.notes}</p></div>` : ''}
                </div>
            `;
        }

        function openAdd() {
            editId = null;
            document.getElementById('modalTitle').textContent = 'Add Client';
            clearForm();
            document.getElementById('modal').classList.add('show');
        }

        function edit(id) {
            const c = clients.find(x => x.id === id);
            editId = id;
            document.getElementById('modalTitle').textContent = 'Edit Client';
            document.getElementById('name').value = c.name || '';
            document.getElementById('phone').value = c.phone || '';
            document.getElementById('email').value = c.email || '';
            document.getElementById('nat').value = c.nat || '';
            document.getElementById('job').value = c.job || '';
            document.getElementById('rel').value = c.rel || '';
            document.getElementById('mar').value = c.mar || '';
            document.getElementById('kids').value = c.kids || '';
            document.getElementById('type').value = c.type || 'buyer';
            document.getElementById('curType').value = c.curType || '';
            document.getElementById('curLoc').value = c.curLoc || '';
            document.getElementById('desType').value = c.desType || '';
            document.getElementById('desLoc').value = c.desLoc || '';
            document.getElementById('beds').value = c.beds || '';
            document.getElementById('bud').value = c.bud || '';
            document.getElementById('date').value = c.date || '';
            document.getElementById('notes').value = c.notes || '';
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            clearForm();
            stopCam();
        }

        function clearForm() {
            ['name','phone','email','nat','job','rel','mar','kids','type','curType','curLoc','desType','desLoc','beds','bud','date','notes'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('type').value = 'buyer';
        }

        function save() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            if (!name || !phone) return alert('Name and phone required!');

            const c = {
                id: editId || 'c' + Date.now(),
                name, phone,
                email: document.getElementById('email').value.trim(),
                nat: document.getElementById('nat').value.trim(),
                job: document.getElementById('job').value.trim(),
                rel: document.getElementById('rel').value,
                mar: document.getElementById('mar').value,
                kids: document.getElementById('kids').value,
                type: document.getElementById('type').value,
                curType: document.getElementById('curType').value,
                curLoc: document.getElementById('curLoc').value.trim(),
                desType: document.getElementById('desType').value,
                desLoc: document.getElementById('desLoc').value.trim(),
                beds: document.getElementById('beds').value.trim(),
                bud: document.getElementById('bud').value.trim(),
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value.trim()
            };

            if (editId) {
                clients = clients.map(x => x.id === editId ? c : x);
                sel = c;
            } else {
                clients.push(c);
                sel = c;
            }

            saveData();
            closeModal();
        }

        function del(id) {
            if (!confirm('Delete?')) return;
            clients = clients.filter(c => c.id !== id);
            sel = null;
            saveData();
        }

        function wa(phone, name) {
            const num = phone.replace(/[^\d]/g, '');
            const formatted = num.startsWith('65') ? num : '65' + num;
            const msg = `Hi ${name}, this is your ERA property agent. I wanted to follow up with you regarding your property search.`;
            window.open(`https://wa.me/${formatted}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function startCam() {
            if (API_KEY === 'YOUR_API_KEY_HERE') return alert('Add API key first!');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('vid').srcObject = stream;
                document.getElementById('camView').style.display = 'block';
                document.getElementById('camBtns').style.display = 'none';
            } catch {
                alert('Camera error');
            }
        }

        function stopCam() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('camView').style.display = 'none';
            document.getElementById('camBtns').style.display = 'block';
        }

        function snap() {
            const v = document.getElementById('vid');
            const c = document.getElementById('can');
            c.width = v.videoWidth;
            c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0);
            c.toBlob(b => process(b), 'image/jpeg');
        }

        function upload(e) {
            if (e.target.files[0]) process(e.target.files[0]);
        }

        async function process(blob) {
            const btn = document.getElementById('snapBtn');
            btn.textContent = '‚è≥ Scanning...';
            btn.disabled = true;
            stopCam();

            try {
                const r = new FileReader();
                r.readAsDataURL(blob);
                r.onloadend = async () => {
                    const b64 = r.result.split(',')[1];
                    const res = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': API_KEY,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            messages: [{
                                role: 'user',
                                content: [
                                    { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: b64 } },
                                    { type: 'text', text: 'Extract: {"name":"","nationality":"","idNumber":""}' }
                                ]
                            }]
                        })
                    });

                    const data = await res.json();
                    const txt = data.content.find(i => i.type === 'text')?.text || '';
                    const match = txt.match(/\{[\s\S]*\}/);
                    
                    if (match) {
                        const info = JSON.parse(match[0]);
                        document.getElementById('name').value = info.name || '';
                        document.getElementById('nat').value = info.nationality || '';
                        const n = document.getElementById('notes');
                        n.value = (n.value ? n.value + '\n' : '') + `ID: ${info.idNumber || 'N/A'}`;
                        alert('‚úÖ Scanned!');
                    }
                };
            } catch (err) {
                alert('‚ùå Failed: ' + err.message);
            } finally {
                btn.textContent = 'üì∑ Capture';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>